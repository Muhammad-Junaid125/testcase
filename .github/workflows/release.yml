name: Release Helm Charts with Per-Chart Changelog

on:
  push:
    branches:
      - main
      - CX-4.10.4
      - CX-5.0-alpha
    paths:
      - 'charts/**'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Tools
        run: |
          # Install yq (Direct Binary)
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          
          # Install git-cliff (Fixed Download)
          # We use the specific tag to avoid redirection issues with 'latest'
          CLIFF_VER=$(curl -s https://api.github.com/repos/orhun/git-cliff/releases/latest | jq -r .tag_name | sed 's/v//')
          curl -L "https://github.com/orhun/git-cliff/releases/download/v${CLIFF_VER}/git-cliff-${CLIFF_VER}-x86_64-unknown-linux-gnu.tar.gz" -o cliff.tar.gz
          tar -xzf cliff.tar.gz
          sudo mv git-cliff-${CLIFF_VER}/git-cliff /usr/local/bin/
          rm -rf cliff.tar.gz git-cliff-${CLIFF_VER}

      - name: Detect changed charts
        id: charts
        shell: bash
        run: |
          # Detect directories changed in the 'charts/' folder
          CHANGED=$(git diff --name-only HEAD~1 HEAD | grep '^charts/' | cut -d/ -f2 | sort -u | xargs echo)
          echo "Found changed charts: $CHANGED"
          echo "list=$CHANGED" >> "$GITHUB_OUTPUT"

      - name: Generate per-chart changelogs
        if: steps.charts.outputs.list != ''
        shell: bash
        run: |
          for chart in ${{ steps.charts.outputs.list }}; do
            CHART_PATH="charts/$chart"
            if [ ! -f "$CHART_PATH/Chart.yaml" ]; then continue; fi

            VERSION=$(yq '.version' "$CHART_PATH/Chart.yaml")
            RELEASE_NAME="${chart}-${VERSION}"

            echo "Generating changelog for $RELEASE_NAME"
            
            # Generate the changelog for this specific folder
            git-cliff \
              --config cliff.toml \
              --include-path "$CHART_PATH/**" \
              --tag "$RELEASE_NAME" \
              --output "$CHART_PATH/CHANGELOG.md"
          done

      - name: Commit and Push Changelogs
        run: |
          git add charts/*/CHANGELOG.md
          git commit -m "docs(changelog): update helm chart changelogs [skip ci]" || echo "No changes to commit"
          git push origin ${{ github.ref_name }}

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Add Helm Repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}