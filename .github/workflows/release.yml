name: Release Helm Charts with Per-Chart Changelog

on:
  push:
    branches:
      - main
      - CX-4.10.4
      - CX-5.0-alpha
    paths:
      - 'charts/**'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for git-cliff to read history

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Tools (yq & git-cliff)
        run: |
          # Install yq
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          # Install git-cliff
          curl -sSL https://github.com/orhun/git-cliff/releases/latest/download/git-cliff-linux-amd64 -o git-cliff.tar.gz
          tar -xzf git-cliff.tar.gz
          sudo mv git-cliff-*/git-cliff /usr/local/bin/
          rm -rf git-cliff.tar.gz git-cliff-*

      - name: Detect changed charts
        id: charts
        shell: bash
        run: |
          # Find directories in charts/ that have changes compared to previous commit
          # If it's a new branch/tag, it compares against the parent
          git diff --name-only HEAD~1 HEAD | grep '^charts/' | cut -d/ -f2 | sort -u > changed_charts.txt
          echo "charts=$(cat changed_charts.txt | tr '\n' ' ')" >> "$GITHUB_OUTPUT"

      - name: Generate per-chart changelogs
        if: steps.charts.outputs.charts != ''
        shell: bash
        run: |
          for chart in ${{ steps.charts.outputs.charts }}; do
            CHART_PATH="charts/$chart"
            if [ ! -f "$CHART_PATH/Chart.yaml" ]; then continue; fi

            VERSION=$(yq '.version' "$CHART_PATH/Chart.yaml")
            RELEASE_NAME="${chart}-${VERSION}"

            echo "Generating changelog for $RELEASE_NAME"
            
            # Using --include-path ensures we only grab commits for THIS chart folder
            git-cliff \
              --config cliff.toml \
              --include-path "$CHART_PATH/**" \
              --tag "$RELEASE_NAME" \
              --output "$CHART_PATH/CHANGELOG.md"
          done

      - name: Commit changelogs
        run: |
          git add charts/*/CHANGELOG.md
          git commit -m "docs(changelog): update helm chart changelogs [skip ci]" || echo "No changes to commit"
          git push origin ${{ github.ref_name }}

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Add Helm Repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add apiseven https://charts.apiseven.com
          helm repo update

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}