name: Release Helm Charts with Changelog

on:
  push:
    branches:
      - main
      - CX-4.10.4
      - CX-5.0-alpha
    paths:
      - 'charts/**'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ------------------------------------
      # Checkout full history
      # ------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------
      # Configure Git
      # ------------------------------------
      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      # ------------------------------------
      # Install yq for YAML processing
      # ------------------------------------
      - name: Install yq
        run: |
          wget -q https://github.com/mikefarah/yq/releases/download/v4.35.2/yq_linux_amd64 -O /tmp/yq
          chmod +x /tmp/yq
          sudo mv /tmp/yq /usr/local/bin/

      # ------------------------------------
      # Add Helm repos
      # ------------------------------------
      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add apisix https://charts.apiseven.com
          helm repo update

      # ------------------------------------
      # Detect changed charts
      # ------------------------------------
      - name: Detect changed charts
        id: charts
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep '^charts/' | cut -d/ -f2 | sort -u | tr '\n' ' ')
          else
            CHANGED=$(find charts -maxdepth 1 -type d | cut -d/ -f2 | grep -v '^$' | tr '\n' ' ')
          fi
          echo "charts=$CHANGED" >> "$GITHUB_OUTPUT"
          echo "Changed charts: $CHANGED"

      # ------------------------------------
      # Generate professional changelogs (custom implementation)
      # ------------------------------------
      - name: Generate per-chart CHANGELOG.md
        if: steps.charts.outputs.charts != ''
        run: |
          # Process only changed charts
          for chart in ${{ steps.charts.outputs.charts }}; do
            chart_dir="charts/${chart}/"

            if [ -f "${chart_dir}Chart.yaml" ]; then
              echo "ðŸ“Š Processing changed chart: $chart"

              # Get current version
              current_version=$(yq '.version' "${chart_dir}Chart.yaml" 2>/dev/null || echo "unknown")
              app_version=$(yq '.appVersion' "${chart_dir}Chart.yaml" 2>/dev/null || echo "unknown")

              # Get previous version tag for this chart
              prev_tag=$(git tag --list "${chart}-*" --sort=-v:refname | head -n 1)
              prev_version="unknown"
              if [ -n "$prev_tag" ]; then
                prev_version=$(echo "$prev_tag" | sed "s/${chart}-//")
              fi

              # Generate changelog header (exact format from example)
              {
                echo "# Change Log"
                echo ""
                echo "## ${current_version}"
                echo ""
                echo "Release date: $(date +%Y-%m-%d)"
                echo ""
                if [ "$app_version" != "unknown" ]; then
                  echo "[AppVersion: ${app_version}] [Helm: v3]"
                  echo ""
                fi
              } > "${chart_dir}CHANGELOG.md"

              # Get commits since last tag
              if [ -n "$prev_tag" ]; then
                # Get commit messages with proper formatting
                commits=$(git log --oneline --no-merges "${prev_tag}..HEAD" -- "${chart_dir}" 2>/dev/null | head -10)

                if [ -n "$commits" ]; then
                  echo "$commits" | while read -r line; do
                    commit_hash=$(echo "$line" | awk '{print $1}')
                    commit_msg=$(echo "$line" | cut -d' ' -f2-)
                    echo "â€¢ ${commit_msg} (${commit_hash})" >> "${chart_dir}CHANGELOG.md"
                  done
                else
                  echo "â€¢ No commits found for this release" >> "${chart_dir}CHANGELOG.md"
                fi
              else
                echo "â€¢ Initial release" >> "${chart_dir}CHANGELOG.md"
              fi

              echo "" >> "${chart_dir}CHANGELOG.md"

              # Add default value changes section with actual git diff
              echo "### Default value changes" >> "${chart_dir}CHANGELOG.md"
              echo "" >> "${chart_dir}CHANGELOG.md"

              if [ -n "$prev_tag" ]; then
                # Get all changed files in this chart
                changed_files=$(git diff --name-only "${prev_tag}..HEAD" -- "${chart_dir}" 2>/dev/null)

                if [ -n "$changed_files" ]; then
                  echo "$changed_files" | while read -r file; do
                    file_diff=$(git diff "${prev_tag}..HEAD" -- "$file" 2>/dev/null)
                    if [ -n "$file_diff" ]; then
                      echo "diff --git a/$file b/$file" >> "${chart_dir}CHANGELOG.md"
                      echo "$file_diff" >> "${chart_dir}CHANGELOG.md"
                      echo "" >> "${chart_dir}CHANGELOG.md"
                    fi
                  done
                else
                  echo "# No changes in this release" >> "${chart_dir}CHANGELOG.md"
                fi
              else
                echo "# Initial release - full configuration" >> "${chart_dir}CHANGELOG.md"
              fi

              echo "" >> "${chart_dir}CHANGELOG.md"
              echo "Autogenerated from Helm Chart and git history using [helm-changelog](https://github.com/mogensen/helm-changelog)" >> "${chart_dir}CHANGELOG.md"

              echo "âœ… Generated changelog for ${chart} v${current_version}"
            fi
          done

      # ------------------------------------
      # Commit changelogs
      # ------------------------------------
      - name: Commit changelogs
        run: |
          git add charts/*/CHANGELOG.md 2>/dev/null || true
          git diff --quiet --cached || (
            git commit -m "docs(changelog): generate professional changelogs [skip ci]"
            git push
          ) || echo "No changes to commit"

      # ------------------------------------
      # Release Helm charts
      # ------------------------------------
      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          skip_existing: true
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
