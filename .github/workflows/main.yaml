name: Release Helm Charts with Changelog

on:
  push:
    branches:
      - main
      - CX-4.10.4
      - CX-5.0-alpha
    paths:
      - 'charts/**'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ------------------------------------
      # Checkout full history
      # ------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------
      # Configure Git
      # ------------------------------------
      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      # ------------------------------------
      # Install Helm
      # ------------------------------------
      - name: Install Helm
        uses: azure/setup-helm@v3

      # ------------------------------------
      # Add Helm repos
      # ------------------------------------
      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add apisix https://charts.apiseven.com
          helm repo update

      # ------------------------------------
      # Detect changed charts
      # ------------------------------------
      - name: Detect changed charts
        id: charts
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep '^charts/' | cut -d/ -f2 | sort -u | tr '\n' ' ')
          else
            CHANGED=$(find charts -maxdepth 1 -type d | cut -d/ -f2 | grep -v '^$' | tr '\n' ' ')
          fi
          echo "charts=$CHANGED" >> "$GITHUB_OUTPUT"
          echo "Changed charts: $CHANGED"

      # ------------------------------------
      # Generate per-chart changelogs
      # ------------------------------------
      - name: Generate per-chart CHANGELOG.md
        if: steps.charts.outputs.charts != ''
        shell: bash
        run: |
          for chart in ${{ steps.charts.outputs.charts }}; do
            CHART_PATH="charts/${chart}"

            # Skip if Chart.yaml doesn't exist
            if [ ! -f "${CHART_PATH}/Chart.yaml" ]; then
              echo "â­ï¸ Skipping ${chart} (Chart.yaml not found)"
              continue
            fi

            # Get chart version
            VERSION=$(yq '.version' "${CHART_PATH}/Chart.yaml" 2>/dev/null || echo "unknown")
            CHART_TAG="${chart}-${VERSION}"
            DATE=$(date +%Y-%m-%d)

            # Get latest tag for this specific chart
            LATEST_TAG=$(git tag --list "${chart}-*" --sort=-v:refname | head -n 1)
            
            if [ -n "$LATEST_TAG" ]; then
              COMMIT_RANGE="${LATEST_TAG}..HEAD"
              echo "ðŸ“Š Generating changelog for ${CHART_TAG} (since ${LATEST_TAG})"
            else
              COMMIT_RANGE="HEAD"
              echo "ðŸ“Š Generating changelog for ${CHART_TAG} (first release)"
            fi

            # Generate changelog with categorized commits
            {
              echo "# Changelog"
              echo ""
              echo "All notable changes to this chart will be documented in this file."
              echo ""
              echo "The format is based on [Keep a Changelog](https://keepachangelog.com/),"
              echo "and this project adheres to [Semantic Versioning](https://semver.org/)."
              echo ""
              echo "## [${VERSION}] - ${DATE}"
              echo ""

              # Get all relevant commits for this chart since last tag
              COMMITS=$(git log ${COMMIT_RANGE} --oneline --no-decorate -- "${CHART_PATH}" 2>/dev/null)
              
              if [ -z "$COMMITS" ]; then
                echo "- No changes in this release"
              else
                # Process commits and categorize them
                echo "$COMMITS" | while read line; do
                  HASH=$(echo "$line" | awk '{print $1}')
                  MESSAGE=$(echo "$line" | cut -d' ' -f2-)
                  
                  # Categorize based on commit message
                  if [[ $MESSAGE =~ ^fix|bug ]]; then
                    ICON="ðŸ›"
                  elif [[ $MESSAGE =~ ^feat|feature ]]; then
                    ICON="ðŸš€"
                  elif [[ $MESSAGE =~ ^docs|doc ]]; then
                    ICON="ðŸ“š"
                  elif [[ $MESSAGE =~ ^perf|performance ]]; then
                    ICON="âš¡"
                  elif [[ $MESSAGE =~ ^refactor|refac ]]; then
                    ICON="ðŸšœ"
                  else
                    ICON="âš™ï¸"
                  fi
                  
                  echo "- ${ICON} ${MESSAGE} (${HASH})"
                done
              fi
            } > "${CHART_PATH}/CHANGELOG.md"

            echo "âœ… Changelog generated for ${chart} v${VERSION}"
          done

      # ------------------------------------
      # Commit changelogs
      # ------------------------------------
      - name: Commit changelogs
        run: |
          git add charts/*/CHANGELOG.md 2>/dev/null || true
          git diff --quiet --cached || (
            git commit -m "docs(changelog): update per-chart changelogs [skip ci]"
            git push
          ) || echo "No changes to commit"

      # ------------------------------------
      # Release Helm charts
      # ------------------------------------
      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          skip_existing: true
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
