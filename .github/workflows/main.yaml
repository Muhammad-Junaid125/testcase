name: Release Helm Charts with Per-Chart Changelog

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ------------------------------------
      # Checkout full history
      # ------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------
      # Configure Git
      # ------------------------------------
      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      # ------------------------------------
      # Install Helm
      # ------------------------------------
      - name: Install Helm
        uses: azure/setup-helm@v3

      # ------------------------------------
      # Install git-cliff for changelog generation
      # ------------------------------------
      - name: Install git-cliff
        run: |
          curl -sSL https://github.com/orhun/git-cliff/releases/download/v0.13.0/git-cliff-v0.13.0-x86_64-unknown-linux-gnu.tar.gz | tar xz -C /tmp/
          sudo mv /tmp/git-cliff /usr/local/bin/

      # ------------------------------------
      # Add Helm repos
      # ------------------------------------
      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add apisix https://charts.apiseven.com
          helm repo update

      # ------------------------------------
      # Detect changed charts
      # ------------------------------------
      - name: Detect changed charts
        id: charts
        shell: bash
        run: |
          git diff --name-only HEAD~1 HEAD \
            | grep '^charts/' \
            | cut -d/ -f2 \
            | sort -u \
            | tr '\n' ' ' > charts.txt

          echo "charts=$(cat charts.txt)" >> "$GITHUB_OUTPUT"

      # ------------------------------------
      # Generate per-chart CHANGELOG.md with git-cliff
      # ------------------------------------
      - name: Generate per-chart CHANGELOG.md
        if: steps.charts.outputs.charts != ''
        shell: bash
        run: |
          for chart in ${{ steps.charts.outputs.charts }}; do

                CHART_PATH="charts/${chart}"

                # ----------------------------------------
                # Skip if Chart.yaml does not exist
                # ----------------------------------------
                if [ ! -f "${CHART_PATH}/Chart.yaml" ]; then
                        echo "Skipping ${chart} (Chart.yaml not found)"
                        continue
                fi

                # ----------------------------------------
                # Read chart version and date
                # ----------------------------------------
                VERSION=$(yq '.version' "${CHART_PATH}/Chart.yaml")
                DATE=$(date +%Y-%m-%d)

                # ----------------------------------------
                # Resolve previous chart tag
                # Format: chartname-X.Y.Z
                # ----------------------------------------
                TAG_PREFIX="$(echo "${chart}" | tr '[:upper:]' '[:lower:]')-"
                PREV_TAG=$(
                        git tag --list "${TAG_PREFIX}*" \
                                --sort=-v:refname \
                        | head -n 1
                )

                if [ -n "${PREV_TAG}" ]; then
                        RANGE="${PREV_TAG}..HEAD"
                else
                        RANGE="HEAD"
                fi

                echo "Generating changelog for ${chart}-${VERSION}"

                # ----------------------------------------
                # Generate changelog with git-cliff
                # ----------------------------------------
                git-cliff ${RANGE} \
                        --include-path "${CHART_PATH}/**" \
                        --config cliff.toml \
                        --tag "${chart}-${VERSION}" \
                        > "${CHART_PATH}/CHANGELOG.md"

                # ----------------------------------------
                # Prepend header if changelog is not empty
                # ----------------------------------------
                if [ -s "${CHART_PATH}/CHANGELOG.md" ]; then
                        {
                                echo "# Changelog"
                                echo ""
                                echo "All notable changes to this project will be documented in this file."
                                echo ""
                                echo "The format is based on [Keep a Changelog](https://keepachangelog.com/),"
                                echo "and this project adheres to [Semantic Versioning](https://semver.org/)."
                                echo ""
                                cat "${CHART_PATH}/CHANGELOG.md"
                        } > "${CHART_PATH}/CHANGELOG.md.tmp" && \
                        mv "${CHART_PATH}/CHANGELOG.md.tmp" "${CHART_PATH}/CHANGELOG.md"
                else
                        # If no changes, create a simple entry
                        {
                                echo "# Changelog"
                                echo ""
                                echo "All notable changes to this project will be documented in this file."
                                echo ""
                                echo "The format is based on [Keep a Changelog](https://keepachangelog.com/),"
                                echo "and this project adheres to [Semantic Versioning](https://semver.org/)."
                                echo ""
                                echo "## [${VERSION}] - ${DATE}"
                                echo ""
                                echo "No changes in this release."
                        } > "${CHART_PATH}/CHANGELOG.md"
                fi

                echo "âœ… Changelog generated for ${chart}-${VERSION}"
          done
      # ------------------------------------
      # Commit changelogs
      # ------------------------------------
      - name: Commit changelogs
        run: |
          git add charts/*/CHANGELOG.md
          git commit -m "docs(changelog): update chart changelogs [skip ci]" || true
          git push

      # ------------------------------------
      # Release charts
      # ------------------------------------
      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          skip_existing: true
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
