name: Release Helm Charts with Changelog

on:
  push:
    branches:
      - main
      - CX-4.10.4
      - CX-5.0-alpha
    paths:
      - 'charts/**'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ------------------------------------
      # Checkout full history
      # ------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------
      # Configure Git
      # ------------------------------------
      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      # ------------------------------------
      # Install Helm
      # ------------------------------------
      - name: Install Helm
        uses: azure/setup-helm@v3

      # ------------------------------------
      # Add Helm repos
      # ------------------------------------
      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add apisix https://charts.apiseven.com
          helm repo update

      # ------------------------------------
      # Detect changed charts
      # ------------------------------------
      - name: Detect changed charts
        id: charts
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep '^charts/' | cut -d/ -f2 | sort -u | tr '\n' ' ')
          else
            CHANGED=$(find charts -maxdepth 1 -type d | cut -d/ -f2 | grep -v '^$' | tr '\n' ' ')
          fi
          echo "charts=$CHANGED" >> "$GITHUB_OUTPUT"
          echo "Changed charts: $CHANGED"

      # ------------------------------------
      # Generate detailed per-chart changelogs
      # ------------------------------------
      - name: Generate per-chart CHANGELOG.md
        if: steps.charts.outputs.charts != ''
        shell: bash
        run: |
          # Initialize root changelog
          {
            echo "# Helm Charts Changelog"
            echo ""
            echo "All notable changes to Helm charts will be documented in this file."
            echo ""
            echo "The format is based on [Keep a Changelog](https://keepachangelog.com/),"
            echo "and this project adheres to [Semantic Versioning](https://semver.org/)."
            echo ""
          } > CHANGELOG.md

          for chart in ${{ steps.charts.outputs.charts }}; do
            CHART_PATH="charts/${chart}"

            # Skip if Chart.yaml doesn't exist
            if [ ! -f "${CHART_PATH}/Chart.yaml" ]; then
              echo "â­ï¸ Skipping ${chart} (Chart.yaml not found)"
              continue
            fi

            # Get chart version
            VERSION=$(yq '.version' "${CHART_PATH}/Chart.yaml" 2>/dev/null || echo "unknown")
            DATE=$(date +%Y-%m-%d)

            # Get last 2 tags for this chart
            TAGS=$(git tag --list "${chart}-*" --sort=-v:refname | head -n 2)
            TAG_ARRAY=($TAGS)
            LATEST_TAG="${TAG_ARRAY[0]}"
            PREVIOUS_TAG="${TAG_ARRAY[1]}"
            
            if [ -n "$LATEST_TAG" ] && [ -n "$PREVIOUS_TAG" ]; then
              COMMIT_RANGE="${PREVIOUS_TAG}..${LATEST_TAG}"
              echo "ðŸ“Š Generating detailed changelog for ${chart} v${VERSION} (${PREVIOUS_TAG} â†’ ${LATEST_TAG})"
            elif [ -n "$LATEST_TAG" ]; then
              COMMIT_RANGE="${LATEST_TAG}..HEAD"
              echo "ðŸ“Š Generating detailed changelog for ${chart} v${VERSION} (since ${LATEST_TAG})"
            else
              COMMIT_RANGE="HEAD"
              echo "ðŸ“Š Generating detailed changelog for ${chart} v${VERSION} (first release)"
            fi

            # Generate per-chart changelog
            {
              echo "# ${chart}"
              echo ""
              echo "## [${VERSION}] - ${DATE}"
              echo ""

              # Get file changes
              if [ -n "$LATEST_TAG" ] && [ -n "$PREVIOUS_TAG" ]; then
                echo "### ðŸ“ Changed Files"
                echo ""
                git diff --name-only ${PREVIOUS_TAG}..HEAD -- "${CHART_PATH}" | sort | while read file; do
                  FILE_NAME=$(echo "$file" | sed "s|${CHART_PATH}/||")
                  echo "- \`${FILE_NAME}\`"
                done
                echo ""
              fi

              # Get commits with proper descriptions
              echo "### ðŸ”„ Commits"
              echo ""
              if [ -n "$LATEST_TAG" ] && [ -n "$PREVIOUS_TAG" ]; then
                COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --no-merges --pretty=format:"%h|%s|%b" -- "${CHART_PATH}" 2>/dev/null)
              else
                COMMITS=$(git log ${COMMIT_RANGE} --no-merges --pretty=format:"%h|%s|%b" -- "${CHART_PATH}" 2>/dev/null)
              fi
              
              if [ -z "$COMMITS" ]; then
                echo "- No changes in this release"
              else
                # Process commits and categorize them with better formatting
                echo "$COMMITS" | while IFS='|' read HASH MESSAGE BODY; do
                  # Skip empty lines
                  if [ -z "$MESSAGE" ]; then
                    continue
                  fi
                  
                  # Categorize based on commit message
                  if [[ $MESSAGE =~ ^fix|^fixed|bug ]]; then
                    ICON="ðŸ› Bug Fix"
                    CATEGORY="Bug Fixes"
                  elif [[ $MESSAGE =~ ^feat|^feature ]]; then
                    ICON="ðŸš€ Feature"
                    CATEGORY="Features"
                  elif [[ $MESSAGE =~ ^docs|^doc ]]; then
                    ICON="ðŸ“š Documentation"
                    CATEGORY="Documentation"
                  elif [[ $MESSAGE =~ ^perf|^performance ]]; then
                    ICON="âš¡ Performance"
                    CATEGORY="Performance"
                  elif [[ $MESSAGE =~ ^refactor ]]; then
                    ICON="ðŸšœ Refactor"
                    CATEGORY="Refactoring"
                  elif [[ $MESSAGE =~ ^update|^chore ]]; then
                    ICON="âš™ï¸ Update"
                    CATEGORY="Updates"
                  else
                    ICON="âœ¨ Change"
                    CATEGORY="Changes"
                  fi
                  
                  # Format commit with hash and message
                  CLEAN_MSG=$(echo "$MESSAGE" | sed 's/^[a-z]*://;s/^[a-z]*(//' | sed 's/):$//')
                  echo "- **${ICON}**: ${CLEAN_MSG} [\`${HASH}\`](https://github.com/${{ github.repository }}/commit/${HASH})"
                done
              fi
              
              echo ""
              echo "---"
              echo ""
            } > "${CHART_PATH}/CHANGELOG.md"

            # Append to root changelog
            {
              echo "## ${chart} - v${VERSION}"
              echo ""
              tail -n +2 "${CHART_PATH}/CHANGELOG.md"
              echo ""
            } >> CHANGELOG.md

            echo "âœ… Changelog generated for ${chart} v${VERSION}"
          done

          echo "ðŸ“„ Root CHANGELOG.md updated"

      # ------------------------------------
      # Commit changelogs
      # ------------------------------------
      - name: Commit changelogs
        run: |
          git add CHANGELOG.md charts/*/CHANGELOG.md 2>/dev/null || true
          git diff --quiet --cached || (
            git commit -m "docs(changelog): generate detailed changelogs [skip ci]"
            git push
          ) || echo "No changes to commit"

      # ------------------------------------
      # Release Helm charts
      # ------------------------------------
      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          skip_existing: true
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
