name: Release Helm Charts with Changelog

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ------------------------------------
      # Checkout full history
      # ------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------
      # Configure Git
      # ------------------------------------
      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      # ------------------------------------
      # Install Helm
      # ------------------------------------
      - name: Install Helm
        uses: azure/setup-helm@v3

      # ------------------------------------
      # Add Helm repos
      # ------------------------------------
      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add apisix https://charts.apiseven.com
          helm repo update

      # ------------------------------------
      # Detect changed charts
      # ------------------------------------
      - name: Detect changed charts
        id: charts
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep '^charts/' | cut -d/ -f2 | sort -u | tr '\n' ' ')
          else
            CHANGED=$(find charts -maxdepth 1 -type d | cut -d/ -f2 | grep -v '^$' | tr '\n' ' ')
          fi
          echo "charts=$CHANGED" >> "$GITHUB_OUTPUT"
          echo "Changed charts: $CHANGED"

      # ------------------------------------
      # Generate CHANGELOG.md (root level)
      # ------------------------------------
      - name: Generate CHANGELOG.md
        uses: requarks/changelog-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          writeToFile: true
          includeInvalidCommits: true
          excludeTypes: build,style
          fromTag: HEAD

      # ------------------------------------
      # Copy and generate per-chart changelogs
      # ------------------------------------
      - name: Generate per-chart CHANGELOG.md
        if: steps.charts.outputs.charts != ''
        shell: bash
        run: |
          for chart in ${{ steps.charts.outputs.charts }}; do
            CHART_PATH="charts/${chart}"

            # Skip if Chart.yaml doesn't exist
            if [ ! -f "${CHART_PATH}/Chart.yaml" ]; then
              echo "â­ï¸ Skipping ${chart} (Chart.yaml not found)"
              continue
            fi

            VERSION=$(yq '.version' "${CHART_PATH}/Chart.yaml" 2>/dev/null || echo "unknown")
            
            # Generate per-chart changelog from git log
            {
              echo "# Changelog"
              echo ""
              echo "All notable changes to this chart will be documented in this file."
              echo ""
              echo "The format is based on [Keep a Changelog](https://keepachangelog.com/),"
              echo "and this project adheres to [Semantic Versioning](https://semver.org/)."
              echo ""
              echo "## [${VERSION}] - $(date +%Y-%m-%d)"
              echo ""
              
              # Extract meaningful commits for this chart
              git log --oneline --all --no-decorate -- "${CHART_PATH}" | head -20 | while read line; do
                HASH=$(echo $line | awk '{print $1}')
                MESSAGE=$(echo $line | cut -d' ' -f2-)
                
                # Categorize commits
                if [[ $MESSAGE == fix* ]] || [[ $MESSAGE == *bug* ]]; then
                  TYPE="ðŸ› Bug Fixes"
                elif [[ $MESSAGE == feat* ]] || [[ $MESSAGE == *feature* ]]; then
                  TYPE="ðŸš€ Features"
                elif [[ $MESSAGE == docs* ]]; then
                  TYPE="ðŸ“š Documentation"
                elif [[ $MESSAGE == perf* ]]; then
                  TYPE="âš¡ Performance"
                else
                  TYPE="âš™ï¸ Other Changes"
                fi
                
                echo "- **${MESSAGE}** (${HASH})"
              done
              
              if [ $(git log --all --no-decorate -- "${CHART_PATH}" | wc -l) -eq 0 ]; then
                echo "- No changes in this release"
              fi
            } > "${CHART_PATH}/CHANGELOG.md"

            echo "âœ… Changelog generated for ${chart} v${VERSION}"
          done

      # ------------------------------------
      # Commit changelogs
      # ------------------------------------
      - name: Commit changelogs
        run: |
          git add CHANGELOG.md charts/*/CHANGELOG.md 2>/dev/null || true
          git commit -m "docs(changelog): update changelogs [skip ci]" || echo "No changes to commit"
          git push || echo "Nothing to push"

      # ------------------------------------
      # Release Helm charts
      # ------------------------------------
      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          skip_existing: true
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
