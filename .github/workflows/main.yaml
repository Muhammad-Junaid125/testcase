name: Release Helm Charts with Changelog

on:
  push:
    branches:
      - main
      - CX-4.10.4
      - CX-5.0-alpha
    paths:
      - 'charts/**'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ------------------------------------
      # Checkout full history
      # ------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------
      # Configure Git
      # ------------------------------------
      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      # ------------------------------------
      # Install yq for YAML processing
      # ------------------------------------
      - name: Install yq
        run: |
          wget -q https://github.com/mikefarah/yq/releases/download/v4.35.2/yq_linux_amd64 -O /tmp/yq
          chmod +x /tmp/yq
          sudo mv /tmp/yq /usr/local/bin/

      # ------------------------------------
      # Install helm-changelog for professional changelogs
      # ------------------------------------
      - name: Install helm-changelog
        run: |
          wget -q https://github.com/mogensen/helm-changelog/releases/download/v0.0.1/helm-changelog_0.0.1_linux_amd64.tar.gz -O /tmp/helm-changelog.tar.gz
          cd /tmp && tar xzf helm-changelog.tar.gz
          sudo mv /tmp/helm-changelog /usr/local/bin/
          helm-changelog --help

      # ------------------------------------
      # Add Helm repos
      # ------------------------------------
      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add apisix https://charts.apiseven.com
          helm repo update

      # ------------------------------------
      # Detect changed charts
      # ------------------------------------
      - name: Detect changed charts
        id: charts
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep '^charts/' | cut -d/ -f2 | sort -u | tr '\n' ' ')
          else
            CHANGED=$(find charts -maxdepth 1 -type d | cut -d/ -f2 | grep -v '^$' | tr '\n' ' ')
          fi
          echo "charts=$CHANGED" >> "$GITHUB_OUTPUT"
          echo "Changed charts: $CHANGED"

      # ------------------------------------
      # Generate professional changelogs with helm-changelog
      # ------------------------------------
      - name: Generate per-chart CHANGELOG.md
        if: steps.charts.outputs.charts != ''
        shell: bash
        run: |
          for chart in ${{ steps.charts.outputs.charts }}; do
            CHART_PATH="charts/${chart}"

            # Skip if Chart.yaml doesn't exist
            if [ ! -f "${CHART_PATH}/Chart.yaml" ]; then
              echo "â­ï¸ Skipping ${chart} (Chart.yaml not found)"
              continue
            fi

            echo "ðŸ“Š Generating professional changelog for ${chart}"

            # Generate changelog using helm-changelog
            cd "${CHART_PATH}" && helm-changelog --output CHANGELOG.md || echo "helm-changelog failed, falling back to basic changelog"

            echo "âœ… Changelog generated for ${chart}"
          done

      # ------------------------------------
      # Generate root CHANGELOG.md
      # ------------------------------------
      - name: Generate root CHANGELOG.md
        run: |
          echo "# Helm Charts Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "All notable changes to Helm charts will be documented in this file." >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "Autogenerated from Helm Chart and git history using [helm-changelog](https://github.com/mogensen/helm-changelog)" >> CHANGELOG.md
          echo "" >> CHANGELOG.md

          # Append each chart's changelog to root
          for chart in ${{ steps.charts.outputs.charts }}; do
            CHART_PATH="charts/${chart}"
            if [ -f "${CHART_PATH}/Chart.yaml" ] && [ -f "${CHART_PATH}/CHANGELOG.md" ]; then
              echo "## ${chart}" >> CHANGELOG.md
              echo "" >> CHANGELOG.md
              cat "${CHART_PATH}/CHANGELOG.md" >> CHANGELOG.md
              echo "" >> CHANGELOG.md
              echo "---" >> CHANGELOG.md
              echo "" >> CHANGELOG.md
            fi
          done

      # ------------------------------------
      # Commit changelogs
      # ------------------------------------
      - name: Commit changelogs
        run: |
          git add CHANGELOG.md charts/*/CHANGELOG.md 2>/dev/null || true
          git diff --quiet --cached || (
            git commit -m "docs(changelog): generate professional changelogs [skip ci]"
            git push
          ) || echo "No changes to commit"

      # ------------------------------------
      # Release Helm charts
      # ------------------------------------
      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          skip_existing: true
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
